name: 'Plugin setup'
description: 'Run plugin setup'
runs:
  using: "composite"
  steps:
    - name: Set custom environment variables
      shell: bash
      run: |
        USER_IGNORE_PATHS="${{ inputs.ignore_paths }}"
        if [ -n "${USER_IGNORE_PATHS}" ]; then
          IGNORE_PATHS="${IGNORE_PATHS},${USER_IGNORE_PATHS}"
          echo "IGNORE_PATHS=${IGNORE_PATHS}" >> $GITHUB_ENV
        fi
    - name: Check out repository code
      uses: actions/checkout@v3
      with:
        path: plugin
        submodules: true
    - name: Install node  ${{ matrix.node }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node }}

    - name: Setup PHP ${{ matrix.php }}
      uses: shivammathur/setup-php@9e72090525849c5e82e596468b86eb55e9cc5401 # v2.32.0
      with:
        php-version: ${{ matrix.php }}
        ini-values: max_input_vars=5000
        extensions: pgsql, mysqli, zip, gd, xmlrpc, soap, ${{ inputs.extra_php_extensions }}
        coverage: none

    - name: Configure Required Composer Version
      id: install-composer1
      if: ${{ matrix.moodle-branch == 'MOODLE_32_STABLE' || matrix.moodle-branch == 'MOODLE_33_STABLE' }}
      run: |
        echo "::set-output name=COMPOSER_VERSION::--1"
      shell: bash

    - name: Update Composer
      if: ${{ matrix.moodle-branch == 'MOODLE_32_STABLE' || matrix.moodle-branch == 'MOODLE_33_STABLE' }}
      run: |
        composer self-update ${{ steps.install-composer1.outputs.COMPOSER_VERSION }}
      shell: bash

    - name: Initialise moodle-plugin-ci
      run: |
        # Initialise moodle-plugin-ci (install via composer)
        echo "::group::Initialise moodle-plugin-ci"

        composer create-project -n --no-dev --prefer-dist moodlehq/moodle-plugin-ci m-ci ^4
        # Add dirs to $PATH
        echo $(cd m-ci/bin; pwd) >> $GITHUB_PATH
        echo $(cd m-ci/vendor/bin; pwd) >> $GITHUB_PATH
        # PHPUnit depends on en_AU.UTF-8 locale
        sudo locale-gen en_AU.UTF-8

        echo "::endgroup::"
      shell: bash

    - name: Install dependencies
      if: ${{ inputs.extra_plugin_runners }}
      run: |
        # Install dependencies
        echo "::group::Install dependencies"

        ${{ inputs.extra_plugin_runners }}

        echo "::endgroup::"
      shell: bash

    - name: Clone Moodle
      # Clone to a temporary directory
      run: |
        echo "::group::Moodle clone output"

        git clone https://github.com/moodle/moodle.git --branch $MOODLE_BRANCH $GITHUB_WORKSPACE/moodletemp

        echo "::endgroup::"
      shell: bash
      env:
        DB: ${{ matrix.database }}
        MOODLE_BRANCH: ${{ matrix.moodle-branch }}

    - name: Install Core Patches
      if: ${{ always() }}
      # Install core patches to moodle in temporary directory
      run: |
        git config --global user.email "test@test.com"
        git config --global user.name "Test"
        ((test -f plugin/patch/${{ matrix.moodle-branch }}.diff && cd $GITHUB_WORKSPACE/moodletemp && git am --whitespace=nowarn < ../plugin/patch/${{ matrix.moodle-branch }}.diff) || echo No patch found;)
      shell: bash

    - name: Install Moodle and Plugin
      # Install moodle, but use our temporary directory to include any potential core patches that have been applied.
      run: |
        # Install moodle commands
        echo "::group::Moodle install output"

        # This is a workaround for https://github.com/moodlehq/moodle-plugin-ci/issues/306 - we disable the git repository validation to allow folder cloning.
        sed -i '/public function gitUrl($url)/{n; s/{/& return $url;/}' $GITHUB_WORKSPACE/m-ci/src/Validate.php

        moodle-plugin-ci install -vvv --plugin ./plugin --db-host=127.0.0.1 --repo $GITHUB_WORKSPACE/moodletemp

        echo "::endgroup::"
      shell: bash
      env:
        DB: ${{ matrix.database }}
        MOODLE_BRANCH: ${{ matrix.moodle-branch }}