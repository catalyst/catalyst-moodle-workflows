name: 'Plugin setup'
description: 'Run plugin setup'
inputs:
  extra_php_extensions:
    description: 'List of additional php packages to install'
  extra_plugin_runners:
    description: 'Command to install dependencies'
  moodle_branch:
    description: 'Moodle branch to use (for patching)'
runs:
  using: "composite"
  steps:
    - name: Check out repository code
      uses: actions/checkout@v3
      with:
        path: plugin
        submodules: true
    - name: Install dependencies
      if: ${{ inputs.extra_plugin_runners }}
      run: |
        # Install dependencies
        echo "::group::Install dependencies"
        ${{ inputs.extra_plugin_runners }}
        echo "::endgroup::"
      shell: bash
    - name: Install Core Patches
      if: ${{ always() }}
      run: |
        git config --global user.email "test@test.com"
        git config --global user.name "Test"
        ((test -f plugin/patch/${{ inputs.moodle_branch }}.diff && cd /moodle && git am --whitespace=nowarn < ../plugin/patch/${{ inputs.moodle_branch }}.diff) || echo No patch found;)
      shell: bash
    - name: Install Moodle and Plugin
        # Install moodle, but use our temporary directory to include any potential core patches that have been applied.
      shell: bash
      run: |
        # Install moodle commands
        echo "::group::Moodle install output"

        # This is a workaround for https://github.com/moodlehq/moodle-plugin-ci/issues/306 - we disable the git repository validation to allow folder cloning.
        sed -i '/public function gitUrl($url)/{n; s/{/& return $url;/}' /ci/src/Validate.php

        moodle-plugin-ci install -vvv --plugin ./plugin --no-init --repo /moodle

        echo "::endgroup::"


